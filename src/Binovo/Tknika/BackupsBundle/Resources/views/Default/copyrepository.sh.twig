#!/bin/bash

MYSQL_DB={{ mysqldb }}
MYSQL_HOST={{ mysqlhost }}
MYSQL_PASSWORD={{ mysqlpassword }}
MYSQL_USER={{ mysqluser }}
REPOSITORY={{ backupsroot }}
SERVER={{ server }}
SERVER_USER={{ backupsuser }}
UPLOADS={{ uploads }}

ssh "$SERVER_USER@$SERVER" "cd '$REPOSITORY'; find . -maxdepth 2 -mindepth 2" | sed s/^..// | while read jobId
do
    echo Backing up job $jobId
    mkdir -p $jobId 2>/dev/null
    rsync -aH --delete "$SERVER_USER@$SERVER:$REPOSITORY/$jobId/" $jobId
done
echo Backing up mysql DB
ssh "$SERVER_USER@$SERVER" "mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD -h$MYSQL_HOST $MYSQL_DB" > tknikabackups.sql
echo Backing up uploads
rsync -aH --delete "$SERVER_USER@$SERVER":"$UPLOADS/" uploads
