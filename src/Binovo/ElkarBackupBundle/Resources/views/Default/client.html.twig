{##
 # @copyright 2012,2013 Binovo it Human Project, S.L.
 # @license http://www.opensource.org/licenses/bsd-license.php New-BSD
 #}
{% extends 'BinovoElkarBackupBundle:Default:base.html.twig' %}
{% trans_default_domain 'BinovoElkarBackup' %}

{% block body %}

<form class="form-horizontal" action="{{ path('saveClient', {id: form.vars.value.id}) }}" method="POST" {{ form_enctype(form) }}>
    <legend>{% trans %}Edit client{% endtrans %}</legend>
    <div class="row-fluid">
        <div class="span6">
{% for flashMessage in app.session.flashbag.get('client') %}
            <div class="controls help-block">
                {{ flashMessage }}
            </div>
{% endfor %}
{% form_theme form 'BinovoElkarBackupBundle:Default:fields.html.twig' %}
            {{ form_row(form.name) }}
            {{ form_row(form.url) }}
            {{ form_row(form.quota) }}
            <div class="control-group">
                <label class="control-label">{% trans %}Disk usage{% endtrans %}</label>
                <div class="controls"><input style="{% if form.vars.value.quota > 0 and form.vars.value.diskUsage / form.vars.value.quota > warning_load_level %}color:red{% endif %}" type="text" class="span12" disabled="disabled" value="{{ (form.vars.value.diskUsage / 1024) | number_format(0)  }} MB{% if form.vars.value.quota > 0 %} ({{ (form.vars.value.diskUsage / form.vars.value.quota * 100) | number_format(0)}}%){% endif %}" /></div>
            </div>
            {{ form_row(form.description) }}
            {{ form_row(form.isActive) }}
            {{ form_row(form.preScripts) }}
            {{ form_row(form.postScripts) }}
        </div>
        <div class="span6">
            {% trans %}client_help{% endtrans %}
        </div>
    </div>
    <div class="row-fluid">
        <div class="span12">
            <legend>{% trans %}Jobs{% endtrans %}</legend>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span6">
        {% for job in form.jobs %}
            <div id="job-{{job.vars.value.id}}">
                <div class="controls">
                    {{ form_widget(job.name, {'attr': {'class': 'input-medium'}}) }}
                    {{ form_widget(job.policy) }}
                    {{ form_widget(job.isActive) }}{% trans %}active{% endtrans %}
                </div>
                <div class="controls">
                    {{ form_widget(job.path, {'attr': {'class': 'span10'}}) }}
                </div>
                <div class="controls">
                    {{ form_widget(job.description, {'attr': {'class': 'span10'}}) }}
                </div>
                <div class="controls">
                    <a href="{{path('showJobBackup', {idClient: job.vars.value.client.id, idJob: job.vars.value.id, action: 'view'}) }}">{% trans %}Backups{% endtrans %} ({{ (job.vars.value.diskUsage / 1024) | number_format(0)  }} MB)</a><br />
                    {{job.vars.value.logEntry.dateTime.format('Y-m-d H:i:s')|default('')}} {{job.vars.value.logEntry.levelName|default('')}} {{ job.vars.value.logEntry.message|default('')|slice(0, 50) }}{% if job.vars.value.logEntry.message|default('')|length > 50 %}[...]{% endif %}

                </div>
                <div class="controls control-row">
                    <input class="btn" type="button" value="{% trans %}Delete{% endtrans %}" onclick="dojo.query('#job-{{job.vars.value.id}}').remove();"/>
                    <input class="btn" type="button" value="{% trans %}Edit{% endtrans %}" onclick="document.location.href='{{ path('editJob', {idJob: job.vars.value.id, idClient: form.vars.value.id}) }}'"/>
                </div>
                <br/>
            </div>
        {% else %}
            <div class="controls">
                {% trans %}There are no jobs{% endtrans %}
            </div>
        {% endfor %}
            <div class="control-group">
                <div class="controls control-row">
                    <input class="btn btn-pull-right" {% if not form.vars.value.id %}disabled="true" {% endif %}type="button" value="{% trans %}Add job{% endtrans %}" onclick="document.location.href='{{ path('editJob', {idJob: 'new', idClient: form.vars.value.id}) }}'"/>
                    <input class="btn btn-pull-right" type="submit" value="{% trans %}Save{% endtrans %}"/>
                </div>
            </div>
            {{ form_widget(form._token) }}
        </div>
        <div class="span6">
            {% trans %}client_job_help{% endtrans %}
        </div>
    </div>
</form>

{% endblock %}
